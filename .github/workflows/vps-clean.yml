name: Clean VPS

on:
  workflow_dispatch:

jobs:
  wipe:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ” Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: ğŸ”¥ Wipe VPS
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} <<'EOF'
            set -e
            echo "âš ï¸ Ğ’ĞĞ˜ĞœĞĞĞ˜Ğ•: Ğ˜Ğ´ĞµÑ‚ Ğ¿Ğ¾Ğ»Ğ½Ğ°Ñ Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ° VPS..."

            echo "ğŸ›‘ ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ²ÑĞµÑ… ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ¾Ğ²..."
            docker stop $(docker ps -aq) || true

            echo "ğŸ—‘ï¸ Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ²ÑĞµÑ… ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ¾Ğ², Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¾Ğ², volume'Ğ¾Ğ²..."
            docker system prune -af --volumes || true

            echo "ğŸ§¹ Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Docker Ğ¸ Docker Compose..."
            apt remove -y docker docker.io containerd docker-compose || true
            apt autoremove -y

            echo "ğŸ—‘ï¸ Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ°Ğ¿Ğ¾Ğº /opt/infra, /opt/data..."
            rm -rf /opt/infra /opt/data /var/lib/docker /var/lib/containerd

            echo "âœ… VPS Ğ¾Ñ‡Ğ¸Ñ‰ĞµĞ½Ğ°. Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ° Ğº Ğ½Ğ¾Ğ²Ğ¾Ğ¼Ñƒ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ."
          EOF
