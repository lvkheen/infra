name: Clean VPS

on:
  workflow_dispatch:

jobs:
  wipe:
    if: github.actor == 'lvkheen'
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ” Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: ğŸ”¥ Wipe VPS
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} <<'EOF'
            set -eux

            echo "âš ï¸ Ğ’ĞĞ˜ĞœĞĞĞ˜Ğ•: ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ° VPS..."

            echo "ğŸ›‘ ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ²ÑĞµÑ… ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ¾Ğ² Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²..."
            docker stop $(docker ps -aq) || true
            docker system prune -af --volumes || true

            echo "ğŸ§¹ Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Portainer Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…..."
            rm -rf /opt/data/portainer || true

            echo "ğŸ§¹ Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Docker Ğ¸ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹..."
            systemctl stop docker || true
            systemctl disable docker || true
            apt-get purge -y docker-ce docker-ce-cli containerd.io docker-compose-plugin docker-ce-rootless-extras docker-buildx-plugin docker.io docker docker-engine containerd runc || true
            apt-get autoremove -y --purge
            apt-get clean

            echo "ğŸ—‘ï¸ Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Docker Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…..."
            rm -rf /var/lib/docker /var/lib/containerd /etc/docker /etc/systemd/system/docker.service.d

            echo "ğŸ§½ Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¸Ñ… Ğ¿Ğ°Ğ¿Ğ¾Ğº..."
            rm -rf /opt/infra /opt/data /opt/*

            echo "âœ… VPS Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ¾Ñ‡Ğ¸Ñ‰ĞµĞ½Ğ°."
          EOF
