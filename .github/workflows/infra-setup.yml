name: Bootstrap VPS (Full Setup)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy'
        required: false
        default: 'main'

jobs:
  bootstrap:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout (–¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ secrets)
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: ‚öôÔ∏è Bootstrap VPS
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} <<'EOF'
            set -e

            echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ Docker..."
            if ! command -v docker >/dev/null; then
              echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker —á–µ—Ä–µ–∑ get.docker.com..."
              curl -fsSL https://get.docker.com | sh
            fi

            echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Docker-—Å–µ—Ä–≤–∏—Å–∞..."
            systemctl restart docker

            echo "üïí –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ Docker..."
            for i in {1..10}; do
              if docker info >/dev/null 2>&1; then
                echo "‚úÖ Docker –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ."
                break
              fi
              echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ ($i)..."
              sleep 2
              if [ "$i" -eq 10 ]; then
                echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å Docker."
                exit 1
              fi
            done

            echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ Docker Compose..."
            if ! command -v docker-compose >/dev/null; then
              echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker Compose..."
              curl -L "https://github.com/docker/compose/releases/download/v2.24.2/docker-compose-linux-x86_64" -o /usr/local/bin/docker-compose
              chmod +x /usr/local/bin/docker-compose
            fi

            echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π..."
            mkdir -p /opt/data/db /opt/data/redis /opt/infra
            chown -R $USER:$USER /opt

            if [ ! -d /opt/infra/.git ]; then
              echo "üîÑ –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ infra..."
              git clone --branch ${{ github.event.inputs.branch }} https://github.com/${{ github.repository }} /opt/infra
            else
              echo "üîÅ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ infra..."
              cd /opt/infra && git pull origin ${{ github.event.inputs.branch }}
            fi

            echo "üöÄ –ó–∞–ø—É—Å–∫ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã..."
            cd /opt/infra
            docker-compose up -d

            echo "‚úÖ –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞."
          EOF
