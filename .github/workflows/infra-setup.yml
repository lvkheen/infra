name: Infra setup

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy'
        required: false
        default: 'main'

jobs:
  bootstrap:
    if: github.actor == 'lvkheen'
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout (–¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ secrets)
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: ‚öôÔ∏è Bootstrap VPS
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} <<'EOF'
            set -e

            echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker —á–µ—Ä–µ–∑ get.docker.com..."
            curl -fsSL https://get.docker.com | sh

            echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Docker-—Å–µ—Ä–≤–∏—Å–∞..."
            sudo systemctl restart docker

            echo "üïí –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ Docker..."
            for i in {1..10}; do
              if sudo docker info >/dev/null 2>&1; then
                echo "‚úÖ Docker –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ."
                break
              fi
              echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ Docker ($i)..."
              sleep 2
              if [ "$i" -eq 10 ]; then
                echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å Docker."
                exit 1
              fi
            done

            echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π..."
            sudo mkdir -p /opt/data/db /opt/data/redis /opt/infra
            sudo chown -R $USER:$USER /opt

            if [ ! -d /opt/infra/.git ]; then
              echo "üîÑ –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ infra..."
              git clone --branch ${{ github.event.inputs.branch }} https://github.com/${{ github.repository }} /opt/infra
            else
              echo "üîÅ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ infra..."
              cd /opt/infra && git pull origin ${{ github.event.inputs.branch }}
            fi

            echo "üì• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–∑–æ–≤..."
            cd /opt/infra
            sudo docker compose pull

            echo "üöÄ –ó–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (—Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã)..."
            sudo docker compose up -d --remove-orphans

            echo "‚úÖ –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞."
          EOF
